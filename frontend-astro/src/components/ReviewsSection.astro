---
import SectionHeader from './SectionHeader.astro'
import { getReviews } from '../api/collections'

const reviews = await getReviews()
---

{reviews.length > 0 && (
  <section class="reviews">
    <SectionHeader title="Отзывы" subtitle="Ваши оценки нашим трудам" />

    <div class="reviews__carousel">
      <div class="reviews__track">
        {reviews.map(review => (
          <div class="reviews__slide">
            <div class="reviews__card">
              <p class="reviews__card-text">"{review.text}"</p>
            </div>
            <div class="reviews__author">
              <p class="reviews__author-name">{review.author}</p>
              <p class="reviews__author-date">{review.date}</p>
            </div>
          </div>
        ))}
      </div>

      <div class="reviews__controls">
        <button class="reviews__arrow reviews__arrow--prev" aria-label="Предыдущий отзыв">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <div class="reviews__dots">
          {reviews.map((_, i) => (
            <button
              class:list={['reviews__dot', { 'reviews__dot--active': i === 0 }]}
              data-index={i}
              aria-label={`Отзыв ${i + 1}`}
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
              </svg>
            </button>
          ))}
        </div>

        <button class="reviews__arrow reviews__arrow--next" aria-label="Следующий отзыв">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </section>
)}

<script>
  function initReviews() {
    const track = document.querySelector('.reviews__track') as HTMLElement
    const slides = document.querySelectorAll('.reviews__slide')
    const dots = document.querySelectorAll('.reviews__dot')
    const prevBtn = document.querySelector('.reviews__arrow--prev')
    const nextBtn = document.querySelector('.reviews__arrow--next')

    if (!track || slides.length === 0) return

    let activeIndex = 0

    function updateDots() {
      dots.forEach((dot, i) => {
        dot.classList.toggle('reviews__dot--active', i === activeIndex)
      })
    }

    function scrollToSlide(index: number) {
      const slide = slides[index] as HTMLElement
      if (!slide) return
      const trackRect = track.getBoundingClientRect()
      const slideRect = slide.getBoundingClientRect()
      const offset = slideRect.left - trackRect.left + track.scrollLeft - (trackRect.width - slideRect.width) / 2
      track.scrollTo({ left: offset, behavior: 'smooth' })
      activeIndex = index
      updateDots()
    }

    prevBtn?.addEventListener('click', () => {
      activeIndex = (activeIndex - 1 + slides.length) % slides.length
      scrollToSlide(activeIndex)
    })

    nextBtn?.addEventListener('click', () => {
      activeIndex = (activeIndex + 1) % slides.length
      scrollToSlide(activeIndex)
    })

    dots.forEach(dot => {
      dot.addEventListener('click', () => {
        const index = Number((dot as HTMLElement).dataset.index)
        scrollToSlide(index)
      })
    })

    // Update active dot on scroll
    let scrollTimeout: ReturnType<typeof setTimeout>
    track.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout)
      scrollTimeout = setTimeout(() => {
        const trackRect = track.getBoundingClientRect()
        const center = trackRect.left + trackRect.width / 2
        let closest = 0
        let minDist = Infinity
        slides.forEach((slide, i) => {
          const rect = slide.getBoundingClientRect()
          const dist = Math.abs(rect.left + rect.width / 2 - center)
          if (dist < minDist) {
            minDist = dist
            closest = i
          }
        })
        activeIndex = closest
        updateDots()
      }, 100)
    })
  }

  initReviews()
  document.addEventListener('astro:after-swap', initReviews)
</script>

<style lang="scss">
.reviews {
  &__carousel {
    background-color: var(--color-primary);
    border-radius: 24px;
    padding: 40px;
    overflow: hidden;
  }

  &__track {
    display: flex;
    gap: 24px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    padding: 0 20%;

    &::-webkit-scrollbar {
      display: none;
    }
  }

  &__slide {
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    width: 60%;
    scroll-snap-align: center;
  }

  &__card {
    flex: 1;
    border: 2px solid var(--color-accent-light);
    border-radius: 32px;
    padding: 28px;
    position: relative;
    margin-bottom: 20px;

    &::before,
    &::after {
      content: '';
      position: absolute;
      bottom: -16px;
      left: 40px;
      width: 0;
      height: 0;
    }

    &::before {
      bottom: -18px;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-top: 18px solid var(--color-accent-light);
    }

    &::after {
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 16px solid var(--color-primary);
      left: 42px;
    }
  }

  &__card-text {
    font-size: 16px;
    line-height: 1.6;
    color: #fff;
  }

  &__author {
    padding: 20px 0 0 8px;
    color: #fff;

    &-name {
      font-family: 'Montserrat Alternates', sans-serif;
      font-size: 18px;
      font-weight: 600;
    }

    &-date {
      font-size: 14px;
      margin-top: 4px;
      opacity: 0.8;
    }
  }

  &__controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 32px;
    margin-top: 32px;
  }

  &__arrow {
    color: #fff;
    transition: opacity 0.3s;

    &:hover {
      opacity: 0.7;
    }
  }

  &__dots {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  &__dot {
    color: rgba(255, 255, 255, 0.4);
    transition: color 0.3s;

    &--active {
      color: #fff;
    }

    &:hover {
      color: rgba(255, 255, 255, 0.7);
    }
  }
}

@media (max-width: 768px) {
  .reviews {
    &__carousel {
      padding: 24px 0;
      border-radius: 0;
      margin-left: -20px;
      margin-right: -20px;
    }

    &__track {
      padding: 0 20px;
      gap: 16px;
    }

    &__slide {
      width: 80%;
      scroll-snap-align: start;
    }

    &__card {
      padding: 20px;
      border-radius: 24px;
    }

    &__card-text {
      font-size: 14px;
    }

    &__author {
      padding: 12px 0 0;

      &-name {
        font-size: 16px;
      }

      &-date {
        font-size: 13px;
      }
    }

    &__controls {
      display: none;
    }
  }
}
</style>
